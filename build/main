#!/usr/bin/env node

// Dependencies
var TinyReq = require("tinyreq")
  , YamlJS = require("yamljs")
  , Fs = require("fs")
  , Logger = require("bug-killer")
  , Streamp = require("streamp")
  , Ul = require("ul")
  ;

// Configurations
Logger.config.logLevel = 4;
Logger.config.displayDate = false;

// Download languages.yml
Logger.log("Downloading the GitHub language colors.", "info");
TinyReq("https://raw.githubusercontent.com/github/linguist/master/lib/linguist/languages.yml", function (err, languages) {
    if (err) {
        Logger.log(err, "error");
        return process.exit(1);
    }
    Logger.log("Parsing the yml file.", "info")

    var parsed = YamlJS.parse(languages)
      , extensions = {}
      , cLng = null
      , cLngExts = null
      , now = new Date()
      , dirName = __dirname + "/../dist/" + now.getDate() + "-" + (now.getMonth() + 1) + "-" + now.getFullYear() + "/"
      , libDir = __dirname + "/../lib/"
      , colorsStr = new Streamp.writable(dirName + "colors.json")
      , extStr = new Streamp.writable(dirName + "extensions.json")
      , libColorsStr = new Streamp.writable(libDir + "colors.json")
      , libExtStr = new Streamp.writable(libDir + "extensions.json")
      ;

    Object.keys(parsed).forEach(function (cLang) {
        cLng = Ul.merge(parsed[cLang], {
            extensions: []
          , aliases: []
        });
        cLngExts = cLng.aliases.concat(cLng.extensions);
        cLngExts.forEach(function (cExt) {
            extensions[cExt.replace(/^\./, "")] = cLng;
        });
    });

    colorsStr.write(JSON.stringify(parsed, null, 2));
    extStr.write(JSON.stringify(extensions, null, 2));

    libColorsStr.write(JSON.stringify(parsed));
    libExtStr.write(JSON.stringify(extensions));

    colorsStr.end();
    extStr.end();
    libColorsStr.end();
    libExtStr.end();

    Logger.log("Done successfully.", "info");
});
